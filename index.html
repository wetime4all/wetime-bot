<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeTime | Unified Platform</title>
    <script src='https://meet.ffmuc.net/external_api.js'></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #6366f1;       
            --secondary: #1e293b;     
            --accent: #F59E0B;        
            --bg: #f8fafc;            
            --surface: #ffffff;       
            --text-main: #334155;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            margin: 0;
            background-color: var(--bg);
            color: var(--text-main);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- LAYOUT & UTILS --- */
        aside { width: 260px; background: var(--secondary); color: white; padding: 20px; display:flex; flex-direction:column; }
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        .logo { font-size: 1.8rem; font-weight: 800; margin-bottom: 40px; }
        .logo span { color: var(--secondary); background: white; padding: 2px 8px; border-radius: 6px; }
        
        /* --- HUD STYLES --- */
        #call-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111827; z-index: 1000; display: none; flex-direction: column;
        }
        .video-feed-placeholder { width: 100%; height: 100%; }
        
        .hud-panel {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 600px;
            background: rgba(255,255,255,0.95);
            border-radius: 16px; padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); text-align: center;
        }
        
        .btn-danger { background: #EF4444; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; position: absolute; top: 20px; right: 20px; z-index: 1001; }
        .hud-controls button { margin: 0 5px; padding: 5px 12px; border-radius: 20px; border: 1px solid #cbd5e1; cursor: pointer; }
        .hud-controls button.active { background: var(--primary); color: white; }

        /* --- GAME CSS (CONNECT 4) --- */
        #game-board {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;
            background: #0ea5e9; padding: 10px; border-radius: 10px;
            margin: 10px auto; max-width: 350px;
        }
        .cell {
            width: 35px; height: 35px; background: white; border-radius: 50%;
            cursor: pointer; border: 2px solid #0284c7; margin: auto;
        }
        .cell.red { background: #ef4444; }
        .cell.yellow { background: #eab308; }
        #game-status { font-weight: bold; margin-bottom: 10px; color: var(--primary); }

    </style>
</head>
<body>

    <aside>
        <div class="logo">We<span>Time</span></div>
        <div>
            <p>üè† Home</p>
            <p>üìá Directory</p>
        </div>
        <div style="margin-top: auto;">
            <p>üë§ <strong>Jonny</strong> (Online)</p>
        </div>
    </aside>

    <main>
        <div style="padding: 20px;">
            <h1>Dashboard</h1>
            <p>Welcome to the WeTime Web App. Launch calls from Slack!</p>
            <div style="background:white; padding:15px; border-radius:10px; display:inline-block;">
                ü™ô Coins: <strong id="coin-balance">...</strong>
            </div>
        </div>
    </main>

    <div id="call-overlay">
        <button class="btn-danger" onclick="endCall()">End Call</button>
        <div class="video-feed-placeholder" id="jitsi-container"></div>

        <div class="hud-panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;">
                <small style="font-weight:bold; color:var(--primary);" id="hud-title">üßä ICEBREAKER HUD</small>
                <small style="cursor:pointer;" id="skip-btn" onclick="nextQuestion()">Skip ‚Üª</small>
            </div>
            
            <div id="mode-questions">
                <div class="hud-controls">
                    <button class="active" onclick="setCategory('fun', this)">Fun</button>
                    <button onclick="setCategory('deep', this)">Deep</button>
                    <button onclick="setCategory('work', this)">Work</button>
                </div>
                <div style="font-size: 1.2rem; font-weight: 600; margin: 15px 0;" id="question-display">
                    "Loading question..."
                </div>
            </div>

            <div id="mode-game" style="display:none;">
                <div id="game-status">Waiting for move...</div>
                <div id="game-board"></div>
                <button onclick="resetGame()" style="background:#cbd5e1; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">New Game</button>
            </div>
        </div>
    </div>

    <div id="overlay-feedback" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:999; display:none; flex-direction:column; align-items:center; justify-content:center;">
        <h1>üéâ Session Complete!</h1>
        <p>You earned <strong>+50 Coins</strong>.</p>
        <button onclick="window.location.reload()" style="padding:10px 20px; background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer;">Close</button>
    </div>

    <script>
        // --- 1. FIREBASE SETUP ---
        // TODO: PASTE YOUR REAL CONFIG HERE
        const firebaseConfig = {
            apiKey: "AIzaSyBMFYXNMF2tooZ3qC8Td_UnazsyndRxQpo",
            authDomain: "wetime-db.firebaseapp.com",
            projectId: "wetime-db",
            storageBucket: "wetime-db.firebasestorage.app",
            messagingSenderId: "1091777307544",
            appId: "1:1091777307544:web:060a10ad3c4be53171c1ed",
            measurementId: "G-8ZM45LYW3L"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- 2. GLOBAL STATE ---
        let jitsiApi = null;
        let userId = null;
        let gameMode = false;
        let boardState = Array(42).fill(null);
        let myColor = null;
        let isMyTurn = false;
        let gameDocRef = null;

        const questions = {
            fun: ["Best meal recently?", "Teleport anywhere?", "Favorite movie?"],
            deep: ["Skill you're learning?", "Biggest influence?", "Best advice?"],
            work: ["Coolest project?", "Productivity hack?", "Remote work pro/con?"]
        };
        let currentCategory = 'fun';

        // --- 3. ON LOAD ---
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomName = urlParams.get('room');
            userId = urlParams.get('user');
            const mode = urlParams.get('mode');

            // Load Coins
            if(userId) {
                db.collection('users').doc(userId).onSnapshot(doc => {
                    if(doc.exists) document.getElementById('coin-balance').innerText = doc.data().coins || 0;
                    else db.collection('users').doc(userId).set({ coins: 450 });
                });
            }

            // Init UI
            if (roomName) {
                startVideoCall(roomName);
                if (mode === 'connect4') {
                    enableGameMode(roomName, userId);
                } else {
                    nextQuestion();
                }
            }
        };

        // --- 4. VIDEO LOGIC ---
        function startVideoCall(roomName) {
            document.getElementById('call-overlay').style.display = 'flex';
            const domain = "meet.ffmuc.net";
            const options = {
                roomName: roomName,
                width: "100%", height: "100%",
                parentNode: document.querySelector('#jitsi-container'),
                configOverwrite: { startWithAudioMuted: false, startWithVideoMuted: false },
                interfaceConfigOverwrite: { TOOLBAR_BUTTONS: ['microphone', 'camera', 'hangup', 'tileview'] }
            };
            jitsiApi = new JitsiMeetExternalAPI(domain, options);
            jitsiApi.addEventListeners({ videoConferenceLeft: () => endCall() });
        }

        function endCall() {
            if (jitsiApi) { jitsiApi.dispose(); jitsiApi = null; }
            document.getElementById('call-overlay').style.display = 'none';
            document.getElementById('overlay-feedback').style.display = 'flex';
            
            // Save Coins
            if (userId) {
                db.collection('users').doc(userId).update({
                    coins: firebase.firestore.FieldValue.increment(50)
                });
            }
        }

        // --- 5. HUD LOGIC (Questions) ---
        function setCategory(cat, btn) {
            currentCategory = cat;
            document.querySelectorAll('.hud-controls button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            nextQuestion();
        }
        function nextQuestion() {
            const list = questions[currentCategory];
            const q = list[Math.floor(Math.random() * list.length)];
            document.getElementById('question-display').innerText = `"${q}"`;
        }

        // --- 6. GAME LOGIC (Connect 4) ---
        function enableGameMode(roomName, uId) {
            gameMode = true;
            document.getElementById('mode-questions').style.display = 'none';
            document.getElementById('mode-game').style.display = 'block';
            document.getElementById('hud-title').innerText = "üïπÔ∏è CONNECT 4";
            document.getElementById('skip-btn').style.display = 'none';

            // Create Grid
            const boardEl = document.getElementById('game-board');
            boardEl.innerHTML = "";
            for (let i = 0; i < 42; i++) {
                let cell = document.createElement('div');
                cell.className = 'cell';
                cell.onclick = () => makeMove(i);
                cell.id = `cell-${i}`;
                boardEl.appendChild(cell);
            }

            // Sync with DB
            gameDocRef = db.collection('games').doc(roomName);
            gameDocRef.onSnapshot((doc) => {
                if (!doc.exists) {
                    // Init Game
                    gameDocRef.set({ board: Array(42).fill(null), redTurn: true, player1: uId });
                } else {
                    const data = doc.data();
                    boardState = data.board;
                    updateBoardUI();
                    
                    // Assign Colors logic
                    if (!myColor) myColor = (data.player1 === uId) ? 'red' : 'yellow';
                    
                    const isRedTurn = data.redTurn;
                    isMyTurn = (myColor === 'red' && isRedTurn) || (myColor === 'yellow' && !isRedTurn);
                    
                    document.getElementById('game-status').innerText = isMyTurn ? "YOUR TURN!" : "Waiting...";
                }
            });
        }

        function makeMove(index) {
            if (!isMyTurn) return;
            const col = index % 7;
            let finalIndex = -1;
            // Drop logic
            for (let row = 5; row >= 0; row--) {
                const i = row * 7 + col;
                if (boardState[i] === null) { finalIndex = i; break; }
            }
            if (finalIndex === -1) return;

            // Optimistic Update
            boardState[finalIndex] = myColor;
            updateBoardUI();

            // Push to DB
            db.runTransaction((transaction) => {
                return transaction.get(gameDocRef).then((sfDoc) => {
                    if (!sfDoc.exists) return;
                    transaction.update(gameDocRef, { 
                        board: boardState, 
                        redTurn: !sfDoc.data().redTurn 
                    });
                });
            });
        }

        function updateBoardUI() {
            boardState.forEach((color, i) => {
                const cell = document.getElementById(`cell-${i}`);
                cell.className = 'cell';
                if (color === 'red') cell.classList.add('red');
                if (color === 'yellow') cell.classList.add('yellow');
            });
        }
        function resetGame() {
            gameDocRef.update({ board: Array(42).fill(null), redTurn: true });
        }
    </script>
</body>
</html>