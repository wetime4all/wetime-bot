<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeTime | Employee Hub</title>
    <script src='https://meet.guifi.net/external_api.js'></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #6366f1; --bg: #f8fafc; --surface: #ffffff;
            --text: #1e293b; --text-light: #64748b;
        }

        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* NAV */
        nav { background: var(--surface); border-bottom: 1px solid #e2e8f0; padding: 0 30px; height: 60px; display: flex; align-items: center; justify-content: space-between; }
        .logo { font-weight: 800; font-size: 1.2rem; }
        .logo span { background: var(--primary); color: white; padding: 2px 8px; border-radius: 6px; }

        /* VIEWS */
        #app-container { flex: 1; position: relative; overflow: hidden; }

        /* DASHBOARD */
        #view-dashboard { padding: 30px; display: grid; grid-template-columns: 300px 1fr 300px; gap: 30px; height: 100%; overflow-y: auto; }
        .card { background: var(--surface); border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0; }

        /* CALL VIEW */
        #view-call { 
            display: none; /* Hidden by default */
            width: 100%; height: 100%; 
            background: #111827; 
            position: absolute; top: 0; left: 0; z-index: 999; 
        }
        #jitsi-container { width: 100%; height: 100%; }

        /* HUD SIDEBAR */
        .hud-sidebar {
            position: absolute; top: 20px; right: 20px; bottom: 20px; width: 340px;
            background: rgba(255,255,255,0.96); border-radius: 16px; padding: 20px;
            display: flex; flex-direction: column; box-shadow: -5px 0 30px rgba(0,0,0,0.3);
        }

        /* UTILS */
        .hidden { display: none !important; }
        .btn-end { background: #fee2e2; color: #ef4444; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <nav>
        <div class="logo">We<span>Time</span></div>
        <div id="debug-info" style="font-size: 0.8rem; color: #ef4444;"></div> 
    </nav>

    <div id="app-container">
        
        <div id="view-dashboard">
            <div class="card">
                <h3>üë§ Profile</h3>
                <h2 id="dash-name">Welcome</h2>
                <div style="background:#1e293b; color:white; padding:15px; border-radius:8px; text-align:center; margin-top:10px;">
                    <div id="break-timer" style="font-size:1.5rem; font-weight:800;">15:00</div>
                </div>
            </div>

            <div class="card">
                <h3>üéÆ Arcade</h3>
                <div style="padding:20px; background:#f1f5f9; border-radius:8px; text-align:center; cursor:pointer;">
                    <span style="font-size:2rem;">üß†</span><br>
                    <strong>Solo Trivia</strong>
                </div>
            </div>

            <div class="card">
                <h3>üèÜ Leaderboard</h3>
                <div id="dash-leaderboard">Loading...</div>
            </div>
        </div>

        <div id="view-call">
            <div id="jitsi-container"></div>
            <div class="hud-sidebar">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <strong>üéÆ GAME HUD</strong>
                    <button class="btn-end" onclick="endCall()">End Call</button>
                </div>
                <div id="hud-content">
                    <p>Waiting for game sync...</p>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBMFYXNMF2tooZ3qC8Td_UnazsyndRxQpo",
            authDomain: "wetime-db.firebaseapp.com",
            projectId: "wetime-db",
            storageBucket: "wetime-db.firebasestorage.app",
            messagingSenderId: "1091777307544",
            appId: "1:1091777307544:web:060a10ad3c4be53171c1ed",
            measurementId: "G-8ZM45LYW3L"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- 2. STARTUP LOGIC ---
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            const roomName = params.get('room');
            const userId = params.get('user');

            // DEBUG: Show URL params on screen to verify
            const debugEl = document.getElementById('debug-info');
            debugEl.innerText = roomName ? `Room found: ${roomName}` : "No Room ID detected";

            if (roomName) {
                // FORCE VIDEO VIEW
                console.log("Starting video in room: " + roomName);
                document.getElementById('view-dashboard').style.display = 'none';
                document.getElementById('view-call').style.display = 'block';
                startVideo(roomName);
            } else {
                // SHOW DASHBOARD
                loadDashboardData();
            }
        };

        // --- 3. VIDEO ENGINE (Guifi.net) ---
        function startVideo(room) {
            const domain = "meet.guifi.net"; // Open instance
            const options = {
                roomName: room,
                parentNode: document.getElementById('jitsi-container'),
                width: '100%',
                height: '100%',
                configOverwrite: { 
                    startWithAudioMuted: false, 
                    startWithVideoMuted: false,
                    prejoinPageEnabled: false // DISABLE PRE-JOIN SCREEN
                },
                interfaceConfigOverwrite: { TOOLBAR_BUTTONS: ['microphone', 'camera', 'hangup'] }
            };
            const api = new JitsiMeetExternalAPI(domain, options);
            api.addEventListeners({ videoConferenceLeft: () => endCall() });
        }

        function endCall() {
            document.getElementById('view-call').style.display = 'none';
            document.getElementById('view-dashboard').style.display = 'grid';
            // Clean URL so refresh doesn't restart call
            window.history.pushState({}, document.title, window.location.pathname);
        }

        // --- 4. DASHBOARD DATA ---
        function loadDashboardData() {
            // Simple Leaderboard Fetch
            db.collection('users').orderBy('stats.wins_total', 'desc').limit(5).get().then(snap => {
                const el = document.getElementById('dash-leaderboard');
                el.innerHTML = "";
                let rank = 1;
                snap.forEach(doc => {
                    const d = doc.data();
                    el.innerHTML += `<div style="padding:5px 0;">#${rank++} <strong>${d.name||'User'}</strong> (${d.stats?.wins_total||0} wins)</div>`;
                });
            });
        }
    </script>
</body>
</html>