<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeTime | Unified Platform</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    // 1. Initialize Firebase
    const firebaseConfig = {
        // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBMFYXNMF2tooZ3qC8Td_UnazsyndRxQpo",
  authDomain: "wetime-db.firebaseapp.com",
  projectId: "wetime-db",
  storageBucket: "wetime-db.firebasestorage.app",
  messagingSenderId: "1091777307544",
  appId: "1:1091777307544:web:060a10ad3c4be53171c1ed",
  measurementId: "G-8ZM45LYW3L"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 2. Get User ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('user');

    // 3. Load Real Coin Balance
    if (userId) {
        db.collection('users').doc(userId).onSnapshot((doc) => {
            if (doc.exists) {
                // Update the UI with real data from DB
                document.getElementById('coin-balance').innerText = doc.data().coins || 0;
                coinBalance = doc.data().coins || 0; // Sync local variable
            } else {
                // If user is new, create them
                db.collection('users').doc(userId).set({ coins: 450, name: "Employee" });
            }
        });
    }

    // 4. Update the EndCall Function to SAVE data
    // (Find your existing endCall function and update the Coin Animation part)
    function endCall() {
        if (jitsiApi) { jitsiApi.dispose(); jitsiApi = null; }
        document.getElementById('call-overlay').style.display = 'none';
        document.getElementById('overlay-feedback').style.display = 'flex';
        
        // SAVE TO DATABASE
        if (userId) {
            // Atomically increment coins by 50
            db.collection('users').doc(userId).update({
                coins: firebase.firestore.FieldValue.increment(50)
            });
        }

        // (Optional) Keep the visual animation if you want, 
        // but the database listener above will handle the text update automatically!
    }
</script>
    <script src='https://meet.jit.si/external_api.js'></script>
    <style>
        :root {
            --primary: #6366f1;       
            --primary-dark: #4338ca;
            --secondary: #1e293b;     
            --accent: #F59E0B;        
            --success: #10B981;       
            --danger: #EF4444;        
            --bg: #f8fafc;            
            --surface: #ffffff;       
            --text-main: #334155;
            --text-light: #64748b;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            margin: 0;
            background-color: var(--bg);
            color: var(--text-main);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- SIDEBAR NAVIGATION --- */
        aside {
            width: 260px;
            background: var(--secondary);
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px;
            transition: 0.3s;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo span { color: var(--primary); background: white; padding: 2px 8px; border-radius: 6px; color: var(--secondary); }

        .nav-item {
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #94a3b8;
            transition: 0.2s;
            font-weight: 500;
        }
        .nav-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-item.active { background: var(--primary); color: white; }
        
        .user-mini-profile {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid #334155;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .avatar-mini { width: 35px; height: 35px; background: #cbd5e1; border-radius: 50%; display:flex; align-items:center; justify-content:center;}

        /* --- MAIN LAYOUT --- */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        /* --- HEADER --- */
        header {
            background: var(--surface);
            padding: 15px 30px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .coin-pill {
            background: #FFFBEB;
            border: 1px solid var(--accent);
            color: #92400E;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .role-toggle {
            display: flex;
            background: #f1f5f9;
            padding: 4px;
            border-radius: 8px;
        }
        .role-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-light);
        }
        .role-btn.active { background: white; color: var(--primary); font-weight: 600; shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* --- VIEWS CONTAINER --- */
        #content-area {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            position: relative;
        }

        .view { display: none; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }

        @keyframes fadeIn { from { opacity:0; transform: translateY(5px); } to { opacity:1; transform: translateY(0); } }

        /* --- COMPONENTS: CARDS --- */
        .card {
            background: var(--surface);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            margin-bottom: 24px;
        }

        .hero-banner {
            background: linear-gradient(135deg, var(--primary), #818cf8);
            color: white;
            border-radius: 16px;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        /* --- DASHBOARD ELEMENTS --- */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .action-card {
            background: var(--surface);
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
        }
        .action-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .action-card h3 { margin: 10px 0 5px 0; }
        
        /* --- PEOPLE GRID --- */
        .people-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        .person-card {
            background: var(--surface);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        .status-dot {
            width: 12px; height: 12px; border-radius: 50%;
            position: absolute; top: 20px; right: 20px;
        }
        .online { background: var(--success); }
        .busy { background: var(--danger); }

        .tag {
            font-size: 0.75rem;
            background: #e0e7ff;
            color: var(--primary);
            padding: 3px 8px;
            border-radius: 10px;
            display: inline-block;
            margin: 2px;
        }

        /* --- VIDEO CALL MODAL (The HUD) --- */
        #call-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #111827;
            z-index: 1000;
            display: none;
            flex-direction: column;
            color: white;
        }

        .video-feed-placeholder {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            background: radial-gradient(circle at center, #1f2937 0%, #000 100%);
            width: 100%;
            height: 100%;
        }

        .hud-panel {
            position: absolute;
            bottom: 30px; left: 50%;
            transform: translateX(-50%);
            width: 90%; max-width: 600px;
            background: rgba(255,255,255,0.95);
            color: var(--text-main);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            text-align: center;
        }

        .icebreaker-text { font-size: 1.2rem; font-weight: 600; margin: 15px 0; min-height: 50px; display: flex; align-items: center; justify-content: center; }
        
        .hud-controls button {
            margin: 0 5px;
            padding: 5px 12px;
            border-radius: 20px;
            border: 1px solid #cbd5e1;
            background: white;
            cursor: pointer;
        }
        .hud-controls button.active { background: var(--primary); color: white; border-color: var(--primary); }

        .call-actions {
            position: absolute;
            top: 20px; right: 20px;
            display: flex; gap: 10px;
            z-index: 1001; /* Above HUD */
        }

        /* --- ADMIN VIEW --- */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-box {
            background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;
        }
        .stat-num { font-size: 2rem; font-weight: 800; color: var(--primary); display: block; margin-bottom: 5px; }

        /* --- UTILS --- */
        .btn-primary {
            background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;
        }
        .btn-danger {
            background: var(--danger); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;
        }
        .hidden { display: none !important; }

    </style>
</head>
<body>

    <aside>
        <div class="logo">We<span>Time</span></div>
        <div class="nav-item active" onclick="navigate('dashboard')"><span>üè†</span> Home</div>
        <div class="nav-item" onclick="navigate('directory')"><span>üìá</span> People Directory</div>
        <div class="nav-item" onclick="navigate('leaderboard')"><span>üèÜ</span> Leaderboard</div>
        <div class="nav-item" id="nav-admin" style="display:none;" onclick="navigate('admin')"><span>‚öôÔ∏è</span> Employer Admin</div>
        <div class="user-mini-profile">
            <div class="avatar-mini">üë§</div>
            <div style="font-size: 0.9rem;">
                <div id="current-user-name" style="font-weight:bold;">Jonny (Ops)</div>
                <div style="color: #94a3b8; font-size: 0.8rem;">Online</div>
            </div>
        </div>
    </aside>

    <main>
        <header>
            <h2 id="page-title" style="margin:0;">Dashboard</h2>
            <div style="display:flex; gap: 20px; align-items: center;">
                <div class="role-toggle">
                    <button class="role-btn active" onclick="setRole('employee')">Employee View</button>
                    <button class="role-btn" onclick="setRole('employer')">Employer View</button>
                </div>
                <div class="coin-pill">
                    <span>ü™ô</span> <span id="coin-balance">450</span>
                </div>
            </div>
        </header>

        <div id="content-area">
            <div id="view-dashboard" class="view active">
                <div class="hero-banner">
                    <div>
                        <h1 style="margin:0;">Welcome back, Troy! üëã</h1>
                        <p style="margin: 10px 0 0 0; opacity: 0.9;">You have <strong>15 minutes</strong> of break time available today.</p>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 2.5rem; font-weight: 800;">üî• 4 Wks</div>
                        <div style="font-size: 0.9rem;">Connection Streak</div>
                    </div>
                </div>

                <h3>Ready to Connect?</h3>
                <div class="action-grid">
                    <div class="action-card" onclick="startMatching('1:1')">
                        <div style="font-size: 3rem;">‚òï</div>
                        <h3>Speed Coffee</h3>
                        <p style="color:#64748b;">Random 1:1 with a colleague.<br>Duration: 5-10 min.</p>
                    </div>
                    <div class="action-card" onclick="startMatching('game')">
                        <div style="font-size: 3rem;">üéÆ</div>
                        <h3>Micro-Game</h3>
                        <p style="color:#64748b;">Play trivia with 3 people.<br>Duration: 5 min.</p>
                    </div>
                    <div class="action-card" onclick="startMatching('metime')">
                        <div style="font-size: 3rem;">üßò</div>
                        <h3>MeTime</h3>
                        <p style="color:#64748b;">Guided breathing or focus.<br>Snooze matching.</p>
                    </div>
                </div>
            </div>
            </div>
    </main>

    <div id="call-overlay">
        <div class="call-actions">
            <button class="btn-danger" onclick="endCall()">End Call</button>
        </div>

        <div class="video-feed-placeholder" id="jitsi-container"></div>

        <div class="hud-panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;">
                <small style="font-weight:bold; color:var(--primary);">üßä ICEBREAKER HUD</small>
                <small style="cursor:pointer;" onclick="nextQuestion()">Skip ‚Üª</small>
            </div>
            <div class="hud-controls">
                <button class="active" onclick="setCategory('fun', this)">Fun</button>
                <button onclick="setCategory('deep', this)">Deep</button>
                <button onclick="setCategory('work', this)">Work</button>
            </div>
            <div class="icebreaker-text" id="question-display">
                "What is the best meal you've had recently?"
            </div>
        </div>
    </div>

    <div id="overlay-feedback" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.98); z-index:999; display:none; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
        <div style="font-size:3rem;">üéâ</div>
        <h2>Great Session!</h2>
        <p>You earned <strong>+50 Coins</strong>.</p>
        <div class="card" style="width:90%; max-width:400px; padding:20px;">
            <h3>Give Kudos to your partner</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:20px 0;">
                <button class="kudo-btn" onclick="toggleKudo(this)" style="padding:15px; border:1px solid #ccc; background:white; border-radius:8px; cursor:pointer;">üëÇ Listener</button>
                <button class="kudo-btn" onclick="toggleKudo(this)" style="padding:15px; border:1px solid #ccc; background:white; border-radius:8px; cursor:pointer;">‚ö° Energy</button>
                <button class="kudo-btn" onclick="toggleKudo(this)" style="padding:15px; border:1px solid #ccc; background:white; border-radius:8px; cursor:pointer;">üß† Insight</button>
                <button class="kudo-btn" onclick="toggleKudo(this)" style="padding:15px; border:1px solid #ccc; background:white; border-radius:8px; cursor:pointer;">üòÇ Funny</button>
            </div>
            <button class="btn-primary" style="width:100%;" onclick="closeFeedback()">Submit & Home</button>
        </div>
    </div>

    <script>
        // --- State ---
        let coinBalance = 450;
        let jitsiApi = null;
        const questions = {
            fun: ["What's the best meal you've had recently?", "If you could teleport anywhere, where would you go?", "What movie do you watch over and over?"],
            deep: ["What's a skill you're trying to learn?", "Who has been the biggest influence on your career?", "What's the best advice you've ever received?"],
            work: ["What's the most interesting project you're on?", "How do you usually start your workday?", "What's one productivity hack you swear by?"]
        };
        let currentCategory = 'fun';

        // --- CHECK FOR ROOM IN URL (From Slack) ---
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomName = urlParams.get('room');
            if (roomName) {
                // If a room param exists, jump straight to the call
                startVideoCall(roomName);
            }
        };

        function startVideoCall(roomName) {
            document.getElementById('call-overlay').style.display = 'flex';
            const domain = "meet.jit.si";
            const options = {
                roomName: roomName,
                width: "100%",
                height: "100%",
                parentNode: document.querySelector('#jitsi-container'),
                configOverwrite: { 
                    startWithAudioMuted: false,
                    startWithVideoMuted: false 
                },
                interfaceConfigOverwrite: { 
                    TOOLBAR_BUTTONS: ['microphone', 'camera', 'hangup', 'tileview', 'chat'] 
                }
            };
            jitsiApi = new JitsiMeetExternalAPI(domain, options);
            
            // Listen for hangup to end call automatically
            jitsiApi.addEventListeners({
                videoConferenceLeft: function () {
                    endCall();
                }
            });

            nextQuestion(); // Load first HUD question
        }

        // --- Navigation Logic ---
        function navigate(viewId) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');
            document.getElementById('page-title').innerText = viewId.charAt(0).toUpperCase() + viewId.slice(1);
        }

        function setRole(role) {
            // (Simulated Logic)
            if (role === 'employer') { navigate('admin'); } else { navigate('dashboard'); }
        }

        // --- Manual Start (Demo Mode) ---
        function startMatching(type) {
            if(type === 'metime') {
                alert("MeTime Activated! üßò"); return;
            }
            // Generate a random room for local testing
            const randomRoom = 'WeTime-' + Math.random().toString(36).substring(7);
            startVideoCall(randomRoom);
        }

        function endCall() {
            if (jitsiApi) { jitsiApi.dispose(); jitsiApi = null; }
            document.getElementById('call-overlay').style.display = 'none';
            document.getElementById('overlay-feedback').style.display = 'flex';
            
            // Coin Animation
            let start = coinBalance;
            coinBalance += 50;
            const balanceEl = document.getElementById('coin-balance');
            let i = 0;
            const interval = setInterval(() => {
                i+=5;
                balanceEl.innerText = start + i;
                if(i >= 50) clearInterval(interval);
            }, 50);
        }

        function closeFeedback() {
            document.getElementById('overlay-feedback').style.display = 'none';
            navigate('dashboard');
        }

        // --- HUD Logic ---
        function setCategory(cat, btn) {
            currentCategory = cat;
            document.querySelectorAll('.hud-controls button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            nextQuestion();
        }

        function nextQuestion() {
            const list = questions[currentCategory];
            const q = list[Math.floor(Math.random() * list.length)];
            document.getElementById('question-display').innerText = `"${q}"`;
        }

        function toggleKudo(btn) {
            btn.style.background = btn.style.background === 'var(--primary)' ? 'white' : 'var(--primary)';
            btn.style.color = btn.style.background === 'white' ? 'black' : 'white';
        }
    </script>
</body>
</html>
