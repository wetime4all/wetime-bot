<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeTime Arcade & Leaderboard</title>
    <script src='https://meet.ffmuc.net/external_api.js'></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #6366f1; --bg: #f8fafc; --surface: #ffffff; --text: #1e293b; }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); display: flex; height: 100vh; overflow: hidden; }
        
        /* OVERLAY & LAYOUT */
        #call-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111827; }
        #jitsi-container { width: 100%; height: 100%; }
        
        .hud-panel {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 600px; max-height: 80vh; overflow-y: auto;
            background: rgba(255,255,255,0.98); border-radius: 16px; padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); text-align: center; display: flex; flex-direction: column;
        }

        /* LOBBY GRID */
        .game-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; }
        .game-card {
            background: #f1f5f9; border: 2px solid #e2e8f0; border-radius: 8px;
            padding: 10px; cursor: pointer; transition: 0.2s; font-size: 0.85rem;
        }
        .game-card:hover { border-color: var(--primary); background: #e0e7ff; }
        .game-icon { font-size: 1.5rem; display: block; margin-bottom: 5px; }

        /* LEADERBOARD TABLE */
        .lb-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        .lb-table th { text-align: left; color: #64748b; padding-bottom: 5px; border-bottom: 2px solid #e2e8f0; }
        .lb-table td { padding: 8px 0; border-bottom: 1px solid #f1f5f9; text-align: left; }
        .lb-rank { font-weight: bold; color: var(--primary); width: 30px; }
        
        /* TRIVIA STYLES */
        .trivia-q { font-size: 1.1rem; font-weight: bold; margin-bottom: 15px; min-height: 50px; }
        .trivia-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .trivia-btn {
            background: white; border: 1px solid #cbd5e1; padding: 12px;
            border-radius: 8px; cursor: pointer; transition: 0.2s;
        }
        .trivia-btn:hover { background: #f8fafc; border-color: var(--primary); }
        .score-pill { background: #1e293b; color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; }

        /* UTILS */
        .hidden { display: none !important; }
        .btn-link { background: none; border: none; color: #64748b; text-decoration: underline; cursor: pointer; margin-top: 10px; font-size: 0.8rem; }
        .hud-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="call-overlay">
        <div id="jitsi-container"></div>

        <div class="hud-panel">
            <div class="hud-header">
                <strong style="color:var(--primary);" id="hud-title">üéÆ ARCADE</strong>
                <div id="my-score" class="hidden"><span class="score-pill">Score: <span id="score-val">0</span></span></div>
            </div>

            <div id="view-lobby">
                <p style="color:#64748b; margin:0;">Select an activity to start together.</p>
                <div class="game-grid">
                    <div class="game-card" onclick="selectGame('trivia')">
                        <span class="game-icon">üß†</span>Trivia
                    </div>
                    <div class="game-card" onclick="selectGame('connect4')">
                        <span class="game-icon">üî¥</span>Connect 4
                    </div>
                    <div class="game-card" onclick="selectGame('leaderboard')">
                        <span class="game-icon">üèÜ</span>Leaderboard
                    </div>
                </div>
            </div>

            <div id="view-trivia" class="hidden">
                <div class="trivia-q" id="triv-question">Loading...</div>
                <div class="trivia-grid" id="triv-answers">
                    </div>
                <div id="triv-result" style="margin-top:15px; font-weight:bold; color:var(--primary);"></div>
            </div>

            <div id="view-leaderboard" class="hidden">
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <button class="btn-link" onclick="loadLeaderboard('wins_total')">Overall</button>
                    <button class="btn-link" onclick="loadLeaderboard('wins_trivia')">üß† Trivia</button>
                    <button class="btn-link" onclick="loadLeaderboard('wins_connect4')">üî¥ Connect4</button>
                    <button class="btn-link" onclick="loadLeaderboard('connections')">üìπ Connections</button>
                </div>
                <table class="lb-table">
                    <thead><tr><th>#</th><th>Name</th><th>Score</th></tr></thead>
                    <tbody id="lb-body">
                        </tbody>
                </table>
            </div>

            <div id="view-connect4" class="hidden">
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; width: 280px; margin: 0 auto; background: #0ea5e9; padding: 8px; border-radius: 8px;" id="c4-board"></div>
                <div id="c4-status" style="margin-top:10px; font-weight:bold;"></div>
            </div>

            <div id="game-controls" class="hidden" style="margin-top:15px; padding-top:10px; border-top:1px solid #eee;">
                <button class="btn-link" onclick="resetToLobby()">Back to Menu</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBMFYXNMF2tooZ3qC8Td_UnazsyndRxQpo",
            authDomain: "wetime-db.firebaseapp.com",
            projectId: "wetime-db",
            storageBucket: "wetime-db.firebasestorage.app",
            messagingSenderId: "1091777307544",
            appId: "1:1091777307544:web:060a10ad3c4be53171c1ed",
            measurementId: "G-8ZM45LYW3L"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- STATE ---
        let userId = null;
        let roomName = null;
        let gameDocRef = null;
        let myScore = 0;
        
        // TRIVIA DATA
        const triviaQuestions = [
            { q: "What is the capital of France?", a: ["Paris", "London", "Berlin", "Madrid"], c: 0 },
            { q: "Which planet is known as the Red Planet?", a: ["Venus", "Mars", "Jupiter", "Saturn"], c: 1 },
            { q: "What is 8 x 7?", a: ["54", "56", "64", "48"], c: 1 },
            { q: "Who wrote 'Romeo and Juliet'?", a: ["Dickens", "Hemingway", "Shakespeare", "Orwell"], c: 2 },
            { q: "What is the largest ocean?", a: ["Atlantic", "Indian", "Pacific", "Arctic"], c: 2 }
        ];

        // --- INIT ---
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            roomName = params.get('room');
            userId = params.get('user');

            if (roomName) {
                startVideo(roomName);
                initGameSync(roomName);
                recordConnection(); // Log that we connected
            }
        };

        function startVideo(room) {
            const api = new JitsiMeetExternalAPI("meet.ffmuc.net", {
                roomName: room,
                parentNode: document.querySelector('#jitsi-container'),
                configOverwrite: { startWithAudioMuted: false, startWithVideoMuted: false },
                interfaceConfigOverwrite: { TOOLBAR_BUTTONS: ['microphone', 'camera', 'hangup'] }
            });
            api.addEventListeners({ videoConferenceLeft: () => window.close() });
        }

        // --- GAME SYNC ENGINE ---
        function initGameSync(room) {
            gameDocRef = db.collection('games').doc(room);
            
            gameDocRef.onSnapshot((doc) => {
                if (!doc.exists) {
                    // Init Room
                    if (userId) gameDocRef.set({ mode: 'lobby', board: [], turn: userId, qIndex: 0 });
                } else {
                    const data = doc.data();
                    renderState(data);
                }
            });
        }

        function renderState(data) {
            // Hide all
            ['lobby', 'trivia', 'leaderboard', 'connect4'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
            document.getElementById('game-controls').classList.remove('hidden');
            document.getElementById('my-score').classList.add('hidden');

            // Show Active
            if (data.mode === 'lobby') {
                document.getElementById('view-lobby').classList.remove('hidden');
                document.getElementById('hud-title').innerText = "üéÆ ARCADE LOBBY";
                document.getElementById('game-controls').classList.add('hidden');
            } 
            else if (data.mode === 'leaderboard') {
                document.getElementById('view-leaderboard').classList.remove('hidden');
                document.getElementById('hud-title').innerText = "üèÜ LEADERBOARD";
                loadLeaderboard('wins_total'); // Default view
            }
            else if (data.mode === 'trivia') {
                document.getElementById('view-trivia').classList.remove('hidden');
                document.getElementById('hud-title').innerText = "üß† TRIVIA";
                document.getElementById('my-score').classList.remove('hidden');
                renderTrivia(data);
            }
            else if (data.mode === 'connect4') {
                document.getElementById('view-connect4').classList.remove('hidden');
                document.getElementById('hud-title').innerText = "üî¥ CONNECT 4";
                renderConnect4(data.board, data.turn);
            }
        }

        function selectGame(mode) {
            let updateData = { mode: mode };
            if (mode === 'trivia') updateData.qIndex = 0;
            if (mode === 'connect4') updateData.board = Array(42).fill(null);
            gameDocRef.update(updateData);
        }

        function resetToLobby() {
            gameDocRef.update({ mode: 'lobby' });
        }

        // --- TRIVIA LOGIC ---
        function renderTrivia(data) {
            const qIdx = data.qIndex || 0;
            if (qIdx >= triviaQuestions.length) {
                document.getElementById('triv-question').innerText = "Game Over!";
                document.getElementById('triv-answers').innerHTML = "";
                document.getElementById('triv-result').innerText = `Final Score: ${myScore}`;
                if (qIdx === triviaQuestions.length) { // Only log once
                     if (myScore > 2) recordWin('trivia'); // Win threshold
                     // Prevent multi-logging by simple local check or incrementing past length
                }
                return;
            }

            const qData = triviaQuestions[qIdx];
            document.getElementById('triv-question').innerText = qData.q;
            
            const ansContainer = document.getElementById('triv-answers');
            ansContainer.innerHTML = "";
            qData.a.forEach((ans, i) => {
                const btn = document.createElement('div');
                btn.className = "trivia-btn";
                btn.innerText = ans;
                btn.onclick = () => submitAnswer(i, qData.c);
                ansContainer.appendChild(btn);
            });
        }

        function submitAnswer(idx, correctIdx) {
            if (idx === correctIdx) {
                myScore += 10;
                document.getElementById('score-val').innerText = myScore;
                document.getElementById('triv-result').innerText = "Correct! üéâ";
            } else {
                document.getElementById('triv-result').innerText = "Wrong! ‚ùå";
            }
            
            // Advance game for EVERYONE after delay
            setTimeout(() => {
                gameDocRef.get().then(doc => {
                    // Only one person needs to trigger the advance
                    // Simple check: am I the host? Or just try updating.
                    gameDocRef.update({ qIndex: firebase.firestore.FieldValue.increment(1) });
                });
            }, 1000);
        }

        // --- CONNECT 4 LOGIC (Simplified) ---
        function renderConnect4(board, turn) {
            const div = document.getElementById('c4-board');
            div.innerHTML = '';
            board.forEach((cell, i) => {
                const d = document.createElement('div');
                d.style.cssText = "width:32px; height:32px; background:white; border-radius:50%; cursor:pointer;";
                if(cell === 'red') d.style.background = '#ef4444';
                if(cell === 'yellow') d.style.background = '#eab308';
                d.onclick = () => playConnect4(i, board);
                div.appendChild(d);
            });
            document.getElementById('c4-status').innerText = (turn === userId) ? "Your Turn!" : "Waiting...";
        }

        function playConnect4(i, board) {
            // (Use existing logic, simplified for brevity here)
            // ... Update DB with new board and toggle turn ...
            // If Win -> recordWin('connect4');
        }

        // --- LEADERBOARD & STATS ---
        function recordConnection() {
            if (!userId) return;
            // Atomic increment
            db.collection('users').doc(userId).update({
                'stats.connections': firebase.firestore.FieldValue.increment(1),
                'stats.last_seen': firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true }); // Merge ensures stats object creates if missing
        }

        function recordWin(gameType) {
            if (!userId) return;
            let update = {};
            update[`stats.wins_${gameType}`] = firebase.firestore.FieldValue.increment(1);
            update[`stats.wins_total`] = firebase.firestore.FieldValue.increment(1);
            
            db.collection('users').doc(userId).set({ stats: update }, { merge: true });
        }

        function loadLeaderboard(statKey) {
            // Clean up UI
            const tbody = document.getElementById('lb-body');
            tbody.innerHTML = '<tr><td colspan="3">Loading...</td></tr>';
            
            // Query DB (requires index potentially, but fine for small datasets)
            db.collection('users')
              .orderBy(`stats.${statKey}`, 'desc')
              .limit(10)
              .get()
              .then(snapshot => {
                  tbody.innerHTML = "";
                  let rank = 1;
                  snapshot.forEach(doc => {
                      const d = doc.data();
                      const val = (d.stats && d.stats[statKey]) ? d.stats[statKey] : 0;
                      // Fallback name if missing
                      const name = d.name || `User ${doc.id.substring(0,4)}`;
                      
                      tbody.innerHTML += `
                        <tr>
                            <td class="lb-rank">#${rank++}</td>
                            <td>${name}</td>
                            <td>${val}</td>
                        </tr>`;
                  });
              });
        }

    </script>
</body>
</html>