<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeTime Arcade</title>
    <script src='https://meet.ffmuc.net/external_api.js'></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #6366f1; --bg: #f8fafc; --surface: #ffffff; --text: #1e293b; }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); display: flex; height: 100vh; overflow: hidden; }
        
        /* --- LAYOUT: SPLIT SCREEN --- */
        #call-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111827; }
        #jitsi-container { width: 100%; height: 100%; }
        
        /* HUD: SIDEBAR STYLE */
        .hud-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            bottom: 20px; /* Stretch to fill height */
            width: 360px; /* Fixed sidebar width */
            
            background: rgba(255,255,255,0.98);
            border-radius: 16px;
            padding: 20px;
            box-shadow: -5px 0 25px rgba(0,0,0,0.3); /* Shadow to left */
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            z-index: 100; /* Above video */
        }

        /* LOBBY GRID (2 Columns for Sidebar) */
        .game-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .game-card {
            background: #f1f5f9; border: 2px solid #e2e8f0; border-radius: 12px;
            padding: 15px; cursor: pointer; transition: 0.2s; font-size: 0.9rem;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .game-card:hover { border-color: var(--primary); background: #e0e7ff; transform: translateY(-2px); }
        .game-icon { font-size: 2rem; display: block; margin-bottom: 5px; }

        /* LEADERBOARD TABLE */
        .lb-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        .lb-table th { text-align: left; color: #64748b; padding-bottom: 5px; border-bottom: 2px solid #e2e8f0; }
        .lb-table td { padding: 8px 0; border-bottom: 1px solid #f1f5f9; text-align: left; }
        .lb-rank { font-weight: bold; color: var(--primary); width: 30px; }
        
        /* TRIVIA STYLES */
        .trivia-q { font-size: 1.1rem; font-weight: bold; margin-bottom: 15px; line-height: 1.4; }
        .trivia-grid { display: flex; flex-direction: column; gap: 8px; }
        .trivia-btn {
            background: white; border: 1px solid #cbd5e1; padding: 12px;
            border-radius: 8px; cursor: pointer; transition: 0.2s; text-align: left;
        }
        .trivia-btn:hover { background: #f8fafc; border-color: var(--primary); }
        .score-pill { background: #1e293b; color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; }

        /* UTILS */
        .hidden { display: none !important; }
        .btn-link { background: none; border: none; color: #64748b; text-decoration: underline; cursor: pointer; margin-top: 10px; font-size: 0.85rem; }
        .hud-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .hud-title { font-size: 1.1rem; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }
    </style>
</head>
<body>

    <div id="call-overlay">
        <div id="jitsi-container"></div>

        <div class="hud-panel">
            <div class="hud-header">
                <div class="hud-title" id="hud-title">üéÆ ARCADE</div>
                <div id="my-score" class="hidden"><span class="score-pill">Pts: <span id="score-val">0</span></span></div>
            </div>

            <div id="view-lobby">
                <p style="color:#64748b; margin:0 0 10px 0; font-size:0.95rem;">Pick an activity:</p>
                <div class="game-grid">
                    <div class="game-card" onclick="selectGame('trivia')">
                        <span class="game-icon">üß†</span>Trivia
                    </div>
                    <div class="game-card" onclick="selectGame('connect4')">
                        <span class="game-icon">üî¥</span>Connect 4
                    </div>
                    <div class="game-card" onclick="selectGame('leaderboard')">
                        <span class="game-icon">üèÜ</span>Ranks
                    </div>
                </div>
            </div>

            <div id="view-trivia" class="hidden">
                <div class="trivia-q" id="triv-question">Loading...</div>
                <div class="trivia-grid" id="triv-answers"></div>
                <div id="triv-result" style="margin-top:15px; font-weight:bold; color:var(--primary); text-align:center;"></div>
            </div>

            <div id="view-leaderboard" class="hidden">
                <div style="display:flex; gap:5px; margin-bottom:15px; flex-wrap:wrap;">
                    <button class="btn-link" onclick="loadLeaderboard('wins_total')">Overall</button>
                    <button class="btn-link" onclick="loadLeaderboard('wins_trivia')">Trivia</button>
                    <button class="btn-link" onclick="loadLeaderboard('connections')">Calls</button>
                </div>
                <table class="lb-table">
                    <thead><tr><th>#</th><th>Name</th><th>Score</th></tr></thead>
                    <tbody id="lb-body"></tbody>
                </table>
            </div>

            <div id="view-connect4" class="hidden">
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; width: 100%; margin: 0 auto; background: #0ea5e9; padding: 8px; border-radius: 8px;" id="c4-board"></div>
                <div id="c4-status" style="margin-top:15px; font-weight:bold; text-align:center;"></div>
            </div>

            <div id="game-controls" class="hidden" style="margin-top:auto; padding-top:15px; border-top:1px solid #eee; text-align:center;">
                <button class="btn-link" onclick="resetToLobby()">‚¨Ö Back to Menu</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBMFYXNMF2tooZ3qC8Td_UnazsyndRxQpo",
            authDomain: "wetime-db.firebaseapp.com",
            projectId: "wetime-db",
            storageBucket: "wetime-db.firebasestorage.app",
            messagingSenderId: "1091777307544",
            appId: "1:1091777307544:web:060a10ad3c4be53171c1ed",
            measurementId: "G-8ZM45LYW3L"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- STATE ---
        let userId = null;
        let roomName = null;
        let gameDocRef = null;
        let myScore = 0;
        
        // TRIVIA DATA
        const triviaQuestions = [
            { q: "What is the capital of France?", a: ["Paris", "London", "Berlin", "Madrid"], c: 0 },
            { q: "Which planet is the Red Planet?", a: ["Venus", "Mars", "Jupiter"], c: 1 },
            { q: "What is 8 x 7?", a: ["54", "56", "64"], c: 1 },
            { q: "Who wrote 'Romeo and Juliet'?", a: ["Dickens", "Shakespeare", "Orwell"], c: 1 },
            { q: "Water boils at what temp (C)?", a: ["90", "100", "110"], c: 1 }
        ];

        // --- INIT ---
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            roomName = params.get('room');
            userId = params.get('user');

            if (roomName) {
                startVideo(roomName);
                initGameSync(roomName);
                recordConnection();
            }
        };

        function startVideo(room) {
            const api = new JitsiMeetExternalAPI("meet.ffmuc.net", {
                roomName: room,
                parentNode: document.querySelector('#jitsi-container'),
                configOverwrite: { startWithAudioMuted: false, startWithVideoMuted: false },
                interfaceConfigOverwrite: { TOOLBAR_BUTTONS: ['microphone', 'camera', 'hangup', 'tileview', 'chat'] }
            });
            api.addEventListeners({ videoConferenceLeft: () => window.close() });
        }

        // --- SYNC ENGINE ---
        function initGameSync(room) {
            gameDocRef = db.collection('games').doc(room);
            gameDocRef.onSnapshot((doc) => {
                if (!doc.exists) {
                    if (userId) gameDocRef.set({ mode: 'lobby', board: [], turn: userId, qIndex: 0 });
                } else {
                    renderState(doc.data());
                }
            });
        }

        function renderState(data) {
            ['lobby', 'trivia', 'leaderboard', 'connect4'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
            document.getElementById('game-controls').classList.remove('hidden');
            document.getElementById('my-score').classList.add('hidden');

            if (data.mode === 'lobby') {
                document.getElementById('view-lobby').classList.remove('hidden');
                document.getElementById('hud-title').innerText = "üéÆ ARCADE";
                document.getElementById('game-controls').classList.add('hidden');
            } 
            else if (data.mode === 'leaderboard') {
                document.getElementById('view-leaderboard').classList.remove('hidden');
                document.getElementById('hud-title').innerText = "üèÜ RANKS";
                loadLeaderboard('wins_total');
            }
            else if (data.mode === 'trivia') {
                document.getElementById('view-trivia').classList.remove('hidden');
                document.getElementById('hud-title').innerText = "üß† TRIVIA";
                document.getElementById('my-score').classList.remove('hidden');
                renderTrivia(data);
            }
            else if (data.mode === 'connect4') {
                document.getElementById('view-connect4').classList.remove('hidden');
                document.getElementById('hud-title').innerText = "üî¥ CONNECT 4";
                renderConnect4(data.board, data.turn);
            }
        }

        function selectGame(mode) {
            let updateData = { mode: mode };
            if (mode === 'trivia') updateData.qIndex = 0;
            if (mode === 'connect4') updateData.board = Array(42).fill(null);
            gameDocRef.update(updateData);
        }

        function resetToLobby() {
            gameDocRef.update({ mode: 'lobby' });
        }

        // --- TRIVIA LOGIC ---
        function renderTrivia(data) {
            const qIdx = data.qIndex || 0;
            if (qIdx >= triviaQuestions.length) {
                document.getElementById('triv-question').innerText = "Game Over!";
                document.getElementById('triv-answers').innerHTML = "";
                document.getElementById('triv-result').innerText = `Your Score: ${myScore}`;
                if (qIdx === triviaQuestions.length && myScore > 0) recordWin('trivia'); 
                return;
            }

            const qData = triviaQuestions[qIdx];
            document.getElementById('triv-question').innerText = qData.q;
            
            const ansContainer = document.getElementById('triv-answers');
            ansContainer.innerHTML = "";
            qData.a.forEach((ans, i) => {
                const btn = document.createElement('div');
                btn.className = "trivia-btn";
                btn.innerText = ans;
                btn.onclick = () => submitAnswer(i, qData.c);
                ansContainer.appendChild(btn);
            });
        }

        function submitAnswer(idx, correctIdx) {
            if (idx === correctIdx) {
                myScore += 10;
                document.getElementById('score-val').innerText = myScore;
                document.getElementById('triv-result').innerText = "Correct! üéâ";
            } else {
                document.getElementById('triv-result').innerText = "Wrong! ‚ùå";
            }
            setTimeout(() => {
                gameDocRef.update({ qIndex: firebase.firestore.FieldValue.increment(1) });
            }, 1000);
        }

        // --- CONNECT 4 LOGIC ---
        function renderConnect4(board, turn) {
            const div = document.getElementById('c4-board');
            div.innerHTML = '';
            board.forEach((cell, i) => {
                const d = document.createElement('div');
                d.style.cssText = "width:100%; aspect-ratio:1/1; background:white; border-radius:50%; cursor:pointer;";
                if(cell === 'red') d.style.background = '#ef4444';
                if(cell === 'yellow') d.style.background = '#eab308';
                d.onclick = () => playConnect4(i, board);
                div.appendChild(d);
            });
            document.getElementById('c4-status').innerText = (turn === userId) ? "Your Turn!" : "Waiting...";
        }

        function playConnect4(i, board) {
            const col = i % 7;
            let finalIndex = -1;
            for (let r = 5; r >= 0; r--) {
                let idx = r * 7 + col;
                if (!board[idx]) { finalIndex = idx; break; }
            }
            if (finalIndex === -1) return;
            
            // Toggle Logic (Simple Host/Guest check)
            // Ideally: we fetch current board, check turn, etc.
            // For MVP Demo: Assume local user is acting correctly
            // We need to fetch DB to know "myRole" (omitted for brevity, checking turn from data passed)
            // Just putting color 'red' for now to prove functionality
            board[finalIndex] = 'red'; 
            gameDocRef.update({ board: board, turn: 'other_user' }); 
        }

        // --- STATS ---
        function recordConnection() {
            if (!userId) return;
            db.collection('users').doc(userId).update({
                'stats.connections': firebase.firestore.FieldValue.increment(1)
            }, { merge: true });
        }

        function recordWin(gameType) {
            if (!userId) return;
            let update = {};
            update[`stats.wins_${gameType}`] = firebase.firestore.FieldValue.increment(1);
            update[`stats.wins_total`] = firebase.firestore.FieldValue.increment(1);
            db.collection('users').doc(userId).set({ stats: update }, { merge: true });
        }

        function loadLeaderboard(statKey) {
            const tbody = document.getElementById('lb-body');
            tbody.innerHTML = '<tr><td colspan="3">Loading...</td></tr>';
            db.collection('users').orderBy(`stats.${statKey}`, 'desc').limit(10).get().then(snapshot => {
                  tbody.innerHTML = "";
                  let rank = 1;
                  snapshot.forEach(doc => {
                      const d = doc.data();
                      const val = (d.stats && d.stats[statKey]) ? d.stats[statKey] : 0;
                      const name = d.name || `User ${doc.id.substring(0,4)}`;
                      tbody.innerHTML += `<tr><td class="lb-rank">#${rank++}</td><td>${name}</td><td>${val}</td></tr>`;
                  });
              });
        }
    </script>
</body>
</html>